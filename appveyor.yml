
version: 3.0.43.{build}
image:
  - Ubuntu2004
  - Visual Studio 2019
pull_requests:
  do_not_increment_build_number: true
clone_depth: 1
for:
-
  matrix:
    except:
      - image: Visual Studio 2019
  environment:
    VCPKG_LIBS: boost-iostreams boost-filesystem boost-system boost-property-tree boost-locale zlib
    DEPLOY_PLATFORM_ID: ubuntu
  init:
  - export CXX=g++-9 CC=gcc-9
  - if [ ! -d ../vcpkg ]; then git clone https://github.com/microsoft/vcpkg.git ../vcpkg ; fi
  - "(cd ../vcpkg && git pull && ./bootstrap-vcpkg.sh)"
  - export VCPKG_DIR=`dirname $(pwd)/../vcpkg/vcpkg`
  install:
  #- sudo apt update -q -y
  - sudo apt install -y debhelper build-essential devscripts fakeroot
  - ../vcpkg/vcpkg install ${VCPKG_LIBS}
  build_script:
  - mkdir build && cd build && cmake -DCMAKE_TOOLCHAIN_FILE="${VCPKG_DIR}/scripts/buildsystems/vcpkg.cmake" ..
  - cmake --build . --config Release
  - cd ..
  cache:
  - ../vcpkg/installed
  after_build:
  - cd build && ../package/deb/builddeb.sh && cd ..
  artifacts:
  - path: v8unpack*.deb
  deploy:
    - provider: GitHub
      auth_token:
        secure: 4f56e4a2-5c56-4b8a-9e8b-8b2f8e4b8f9e # Replace with actual encrypted token
      artifact: /v8unpack-.*\.deb$/
      draft: false
      prerelease: false
      on:
        appveyor_repo_tag: true # Only deploy on tagged commits

-
  matrix:
    only:
      - image: Visual Studio 2019
  environment:
    VCDIR: C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\
    BOOST_ROOT: C:\Libraries\boost_1_75_0
    BOOST_LIBRARYDIR: C:\Libraries\boost_1_75_0\lib32-msvc-14.2
    BOOST_INCLUDEDIR: C:\Libraries\boost_1_75_0
    DEPLOY_PLATFORM_ID: win
  install:
  - cmd: >-
      appveyor DownloadFile https://github.com/madler/zlib/archive/v1.2.11.zip -FileName zlib-1.2.11.zip

      7z x zlib-1.2.11.zip > NUL

      cd zlib-1.2.11

      md build

      cd build

      cmake -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DCMAKE_SHARED_LINKER_FLAGS="/NODEFAULTLIB:MSVCRT" -DCMAKE_C_FLAGS_RELEASE="/MT /O2 /Ob2 /D NDEBUG" ..

      cmake --build . --config Release --target zlibstatic

      copy zconf.h ..

      cd ..

      cd ..
  build_script:
  - cmd: >-
      call "%VCDIR%"\vcvarsall.bat x64 || call "%VCDIR%"\vcvars32.bat

      cmake -G "Visual Studio 16 2019" -DBOOST_ROOT="%BOOST_ROOT%" -DBOOST_LIBRARYDIR="%BOOST_LIBRARYDIR%" -DBOOST_INCLUDEDIR="%BOOST_INCLUDEDIR%" -DZLIB_LIBRARY=%APPVEYOR_BUILD_FOLDER%\zlib-1.2.11\build\Release\zlibstatic.lib -DZLIB_INCLUDE_DIR=%APPVEYOR_BUILD_FOLDER%\zlib-1.2.11 .

  - cmake --build . --config Release
  after_build:
  - cmd: >-
      SET PATH=%PATH%;"C:/Program Files (x86)/WiX Toolset v3.11/bin"

      copy Release\v8unpack.exe package

      copy LICENSE package

      copy README.md package

      cd package

      candle v8unpack.wxs

      light -out v8unpack-%APPVEYOR_BUILD_VERSION%.msi v8unpack.wixobj

      choco pack

  artifacts:
  - path: Release\*.exe
    name: v8unpack.exe
  - path: package\v8unpack*.nupkg
    name: v8unpack.nupkg
  - path: package\v8unpack-*.msi
    name: v8unpack.msi
  deploy:
    - provider: GitHub
      auth_token:
        secure: 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 # Replace with actual encrypted token
      artifact: /v8unpack-.*\.(exe|msi|nupkg)/
      draft: false
      prerelease: false
      on:
        branch: master
        appveyor_repo_tag: true # deploy on tag push only
