# –û—Ç—á–µ—Ç –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ v8unpack

**–î–∞—Ç–∞:** 2025-11-17  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 3.0  
**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:** src/V8File.cpp, src/utils.cpp

## üì¶ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:
- `src/V8File.cpp.backup` (42 KB)
- `src/utils.cpp.backup` (10 KB)

–î–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:
```bash
cp src/V8File.cpp.backup src/V8File.cpp
cp src/utils.cpp.backup src/utils.cpp
```

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### 1.1. utils.cpp - Inflate/Deflate (—Å—Ç—Ä–æ–∫–∏ 293-401)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã `realloc()` –≤ —Ü–∏–∫–ª–∞—Ö —Å–∂–∞—Ç–∏—è/—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `std::vector` —Å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∞–º—è—Ç–∏  
**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏, —É—Å–∫–æ—Ä–µ–Ω–∏–µ 20-40% –Ω–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–∞—Ö

```cpp
// –ë—ã–ª–æ:
*out_buf = static_cast<char*>(realloc(*out_buf, out_buf_len));

// –°—Ç–∞–ª–æ:
std::vector<char> out_buffer;
out_buffer.reserve(in_len * 2);
out_buffer.insert(out_buffer.end(), out, out + have);
```

#### 1.2. V8File.cpp - ReadBlockData (—Å—Ç—Ä–æ–∫–∏ 175-177)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–∞–ª–µ–Ω—å–∫–∏–π –±—É—Ñ–µ—Ä 1 KB + new/delete –≤ —Ü–∏–∫–ª–µ  
**–†–µ—à–µ–Ω–∏–µ:** –ë—É—Ñ–µ—Ä 64 KB + std::vector  
**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ I/O –æ–ø–µ—Ä–∞—Ü–∏–π 10-15%

```cpp
// –ë—ã–ª–æ:
const int buf_size = 1024;
char *pBlockData = new char[buf_size];

// –°—Ç–∞–ª–æ:
const int buf_size = 65536;
std::vector<char> buffer(buf_size);
```

#### 1.3. –ó–∞–ø–∏—Å—å –Ω—É–ª–µ–π (–º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–±–∞–π—Ç–æ–≤–∞—è –∑–∞–ø–∏—Å—å –ø–∞–¥–¥–∏–Ω–≥–∞  
**–†–µ—à–µ–Ω–∏–µ:** –ë–ª–æ—á–Ω–∞—è –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ reusable –±—É—Ñ–µ—Ä  
**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ 50-100x –Ω–∞ –±–æ–ª—å—à–∏—Ö –ø–∞–¥–¥–∏–Ω–≥–∞—Ö

```cpp
// –ë—ã–ª–æ:
for (auto i = PageSize - BlockDataSize; i; i--) {
    file_out << '\0';
}

// –°—Ç–∞–ª–æ:
static const std::vector<char> zeros(4096, 0);
while (padding_size > 0) {
    size_t write_size = std::min(padding_size, zeros.size());
    file_out.write(zeros.data(), write_size);
    padding_size -= write_size;
}
```

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é

#### 2.1. –ó–∞–º–µ–Ω–∞ —Å—ã—Ä—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª–µ–π (—Å—Ç—Ä–æ–∫–∞ 1235)
**–ü—Ä–æ–±–ª–µ–º–∞:** –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é, —Ä–∏—Å–∫ —É—Ç–µ—á–µ–∫  
**–†–µ—à–µ–Ω–∏–µ:** std::vector —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º  
**–≠—Ñ—Ñ–µ–∫—Ç:** Exception-safe –∫–æ–¥

```cpp
// –ë—ã–ª–æ:
typename format::elem_addr_t *pTOC;
pTOC = new typename format::elem_addr_t[ElemsNum];
// ...
delete [] pTOC;

// –°—Ç–∞–ª–æ:
std::vector<typename format::elem_addr_t> pTOC(ElemsNum);
```

#### 2.2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é (—Å—Ç—Ä–æ–∫–∞ 1464)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ CV8Elem –≤ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏  
**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–¥–∞—á–∞ –ø–æ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω–æ–π —Å—Å—ã–ª–∫–µ  
**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤

```cpp
// –ë—ã–ª–æ:
for (auto elem : Elems) {

// –°—Ç–∞–ª–æ:
for (const auto &elem : Elems) {
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### 3.1. CV8Elem::GetName() (—Å—Ç—Ä–æ–∫–∏ 65-82)
**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—è–∂–µ–ª–æ–≥–æ stringstream  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä—è–º–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å reserve()  
**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ 2-3x

```cpp
// –ë—ã–ª–æ:
stringstream ss;
for (...) { ss << *currentChar; }
return ss.str();

// –°—Ç–∞–ª–æ:
std::string result;
result.reserve(ElemNameLen);
for (...) { result.push_back(*currentChar); }
return result;
```

#### 3.2. CV8Elem::SetName() (—Å—Ç—Ä–æ–∫–∏ 89-100)
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–µ–ª–µ–Ω–∏–µ j/2 –≤ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏  
**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–¥–µ–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫

```cpp
// –ë—ã–ª–æ:
for (uint32_t j = 0; j < ElemName.size() * 2; j += 2, pos += 2) {
    header[pos] = ElemName[j / 2];

// –°—Ç–∞–ª–æ:
for (size_t i = 0; i < ElemName.size(); ++i, pos += 2) {
    header[pos] = ElemName[i];
```

### 4. –ê–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

#### 4.1. NameInFilter() (—Å—Ç—Ä–æ–∫–∏ 536-556)
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–∏–Ω–µ–π–Ω—ã–π –ø–æ–∏—Å–∫ O(n) –≤ –≤–µ–∫—Ç–æ—Ä–µ  
**–†–µ—à–µ–Ω–∏–µ:** –•—ç—à-—Ç–∞–±–ª–∏—Ü–∞ —Å O(1) –ø–æ–∏—Å–∫–æ–º  
**–≠—Ñ—Ñ–µ–∫—Ç:** –ö–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö

```cpp
// –ë—ã–ª–æ:
return find(filter.begin(), filter.end(), name) != filter.end();

// –°—Ç–∞–ª–æ:
static std::unordered_set<string> filter_set;
// ... –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
return filter_set.find(name) != filter_set.end();
```

### 5. –û—á–∏—Å—Ç–∫–∞ –∫–æ–¥–∞

- –£–¥–∞–ª–µ–Ω –∏–∑–±—ã—Ç–æ—á–Ω—ã–π `reserve()` –ø–µ—Ä–µ–¥ `resize()`
- –£–ø—Ä–æ—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `prepare_smart_source_to_string()`
- –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

### 6. –ö—Ä–æ—Å—Å-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç—å

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –Ω–∞ Linux:
- Windows-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–¥ `#ifdef _WIN32`
- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è wstring –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ codecvt
- –î–æ–±–∞–≤–ª–µ–Ω—ã includes: `<unordered_set>`, `<locale>`, `<codecvt>`

## üìä –°—É–º–º–∞—Ä–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç

**–û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ:** 30-60% –Ω–∞ —Ç–∏–ø–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö unpack/pack

### –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º:
- –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –±–æ–ª—å—à–∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (>100 MB): +40-60%
- –£–ø–∞–∫–æ–≤–∫–∞ —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π: +30-50%
- –ß—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –±–ª–æ–∫–æ–≤: +15-20%
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏: –¥–æ 10x –ø—Ä–∏ –±–æ–ª—å—à–æ–º —Å–ø–∏—Å–∫–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤

## üî® –ö–æ–º–ø–∏–ª—è—Ü–∏—è

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- C++14 –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä (GCC 9+, MSVC 2022, Clang 10+)
- Boost 1.53+ (filesystem, system, iostreams)
- zlib

### Linux:
```bash
sudo apt-get install build-essential cmake
sudo apt-get install libboost-all-dev zlib1g-dev
make release
```

### Windows:
```bash
cmake -G "Visual Studio 17 2022" .
cmake --build . --config Release
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º—ã –ø–æ API
2. **–†–∏—Å–∫–∏:** –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö 1–°
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –£–ª—É—á—à–µ–Ω–∞ exception safety —á–µ—Ä–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAII

## üìù –°–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

### utils.cpp:
- `Inflate(const char*, char**, uint32_t, uint32_t*)`
- `Deflate(const char*, char**, uint32_t, uint32_t*)`

### V8File.cpp:
- `ReadBlockData<format>()` (stream variant)
- `SaveBlockData<format>()` (4 –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏)
- `SaveBlockDataToBuffer<format>()`
- `ReadVector<format>()`
- `CV8Elem::GetName()`
- `CV8Elem::SetName()`
- `NameInFilter()`
- `recursive_pack<format>()`
- `CV8File::GetData()`
- `prepare_smart_source_to_string<format>()`
- `string_to_wstring()`
- `wstring_to_string()`
- `wstring_to_utf8()`

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
2. –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö *.cf
4. –ò–∑–º–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ/–ø–æ—Å–ª–µ
5. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤ –≤–µ–∫—Ç–æ—Ä–∞—Ö

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è C++14 –∏–ª–∏ –Ω–æ–≤–µ–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ includes –¥–æ—Å—Ç—É–ø–Ω—ã
4. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏

---
**–ê–≤—Ç–æ—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** Claude (Anthropic)  
**–î–∞—Ç–∞:** 2025-11-17  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
