# V8Unpack - Документация

## Обзор

V8Unpack - это утилита командной строки для распаковки, упаковки, сжатия и распаковки файлов конфигураций 1C:Предприятие v8. Поддерживает различные форматы файлов:
- `.cf` - Файлы конфигураций
- `.epf` - Файлы внешней обработки
- `.erf` - Файлы внешних отчетов

## Возможности

- **Распаковка**: Извлечение файлов конфигураций в структуру каталогов
- **Упаковка**: Создание файлов конфигураций из структуры каталогов
- **Сжатие/Распаковка**: Сжатие/распаковка двоичных потоков данных
- **Парсинг**: Извлечение конкретных блоков метаданных
- **Сборка**: Построение файлов конфигураций с оптимизациями

## Установка

### Готовые пакеты

#### Ubuntu/Debian
```bash
sudo apt-add-repository ppa:dmpas/e8
sudo apt-get update
sudo apt-get install v8unpack
```

#### Fedora/CentOS
```bash
cd /etc/yum.repos.d/
sudo wget http://download.opensuse.org/repositories/home:/pumbaEO/Fedora_22/home:pumbaEO.repo
sudo dnf install v8unpack
```

#### Chocolatey (Windows)
```bash
choco install v8unpack -source https://www.myget.org/F/onescript -y
```

#### Прямое скачивание
Исполняемый файл для Windows: [Последняя сборка](https://ci.appveyor.com/api/projects/dmpas/v8unpack/artifacts/Release%2Fv8unpack.exe?branch=master)

### Сборка из исходников

#### Необходимые компоненты
- CMake
- Библиотеки Boost
- Компилятор C++ (GCC/Clang/Visual Studio)

#### Linux/macOS
```bash
mkdir build && cd build
cmake ..
make
sudo make install
```

#### Windows
```bash
mkdir build && cd build
cmake .. -G "Visual Studio 16 2019"
cmake --build . --config Release
```

## Использование командной строки

```
V8Unpack [ОПЦИИ] [ПАРАМЕТРЫ]
```

### Основные команды

#### Распаковка файлов

**Распаковка файла конфигурации в каталог:**
```bash
v8unpack -unpack входной.cf выходной_каталог [имя_блока]
```
- `входной.cf` - Исходный файл конфигурации
- `выходной_каталог` - Целевой каталог для извлеченных файлов
- `имя_блока` - Необязательный конкретный блок для извлечения

**Пакетная распаковка из файла списка:**
```bash
v8unpack -unpack -list список.txt
```

#### Упаковка файлов

**Упаковка каталога в файл конфигурации:**
```bash
v8unpack -pack входной_каталог выходной.cf
```
- `входной_каталог` - Исходный каталог с распакованными файлами
- `выходной.cf` - Целевой файл конфигурации

**Пакетная упаковка из файла списка:**
```bash
v8unpack -pack -list список.txt
```

#### Сжатие/Распаковка

**Распаковка сжатого файла данных:**
```bash
v8unpack -inflate входной.data выходной_файл
```

**Сжатие файла данных:**
```bash
v8unpack -deflate входной_файл выходной.data
```

**Пакетные операции:**
```bash
v8unpack -inflate -list список.txt
v8unpack -deflate -list список.txt
```

#### Парсинг метаданных

**Парсинг файла конфигурации:**
```bash
v8unpack -parse входной_файл выходной_каталог [блок1 блок2 ...]
```
Извлекает конкретные блоки метаданных или все блоки, если не указаны.

#### Сборка конфигураций

**Сборка конфигурации с упаковкой:**
```bash
v8unpack -build входной_каталог выходной_файл
```

**Сборка конфигурации без упаковки (только сборка):**
```bash
v8unpack -build -nopack входной_каталог выходной_файл
```

### Служебные команды

**Показать версию:**
```bash
v8unpack -version
```

**Показать справку по использованию:**
```bash
v8unpack -example
```

**Создать шаблоны пакетных файлов:**
```bash
v8unpack -bat
```

**Показать список файлов в контейнере:**
```bash
v8unpack -listfiles входной_файл
```

## Пакетная обработка

Создайте файл списка с параметрами, разделенными точкой с запятой:

```
unpack;config.cf;unpacked_config
inflate;data.bin;data.txt
```

Обработайте список:
```bash
v8unpack -list пакетные_команды.txt
```

## Форматы файлов и структура

### Структура файла конфигурации

Файлы конфигураций 1C v8 используют контейнерный формат, содержащий:
- **Метаданные** - Структура конфигурации и свойства
- **Двоичные данные** - Сжатые потоки содержимого
- **Таблицы индексов** - Информация о распределении файлов

### Распакованная структура

```
config.cf (распакованный)
├── root
├── metadata.data (сжатый)
├── [ГУИДы]/
│   ├── data
│   └── metadata
└── ...
```

## Парсер метаданных

V8Unpack включает встроенный парсер метаданных, поддерживающий парсинг различных объектов метаданных 1C v8:

### Поддерживаемые типы объектов

- **Конфигурация** - Корневой объект конфигурации
- **Общие модули** - Общие модули кода
- **Константы** - Константы конфигурации
- **Справочники** - Справочники данных
- **Документы** - Бизнес-документы
- **Перечисления** - Типы перечислений
- **Отчеты** - Объекты отчетов
- **Обработки** - Алгоритмы обработки данных
- **Планы счетов/видов характеристик** - Учетные структуры
- **Регистры сведений/накопления** - Структуры хранения данных
- **Бизнес-процессы** - Определения рабочих процессов
- **Задачи** - Объекты управления задачами
- **Внешние источники данных** - Внешние подключения

### Использование парсера

Парсинг всех метаданных:
```bash
v8unpack -parse config.cf выходной_каталог
```

Парсинг конкретных объектов:
```bash
v8unpack -parse config.cf выходной_каталог catalogs documents
```

## Примеры

### Полный рабочий процесс распаковки

```bash
# Шаг 1: Распаковка основного контейнера
v8unpack -unpack myconfig.cf unpacked

# Шаг 2: Распаковка метаданных
v8unpack -inflate unpacked/metadata.data unpacked/metadata.xml

# Шаг 3: Распаковка контейнера метаданных
v8unpack -unpack unpacked/metadata.xml unpacked/metadata

# Шаг 4: Парсинг структуры конфигурации
v8unpack -parse myconfig.cf config_structure
```

### Полный рабочий процесс упаковки

```bash
# Шаг 1: Упаковка метаданных
v8unpack -pack unpacked/metadata metadata_new.data

# Шаг 2: Сжатие метаданных
v8unpack -deflate metadata_new.data metadata.data

# Шаг 3: Замена в распакованной структуре
cp metadata.data unpacked/

# Шаг 4: Упаковка итоговой конфигурации
v8unpack -pack unpacked myconfig_new.cf
```

### Генерация пакетных файлов

Создание шаблона пакетного файла Windows:
```bash
v8unpack -bat > process_config.bat
```

Это создаст пакетный файл с макросами для распаковки/упаковки.

## Оптимизация производительности

Версия 3.0 включает значительные улучшения производительности:
- **Динамическая сборка корневого контейнера** - Исключает переполнение памяти для больших конфигураций
- **Оптимизированное сжатие** - Эффективные операции deflate/inflate
- **Управление памятью** - Сниженное использование памяти для больших файлов

## Обработка ошибок

Утилита возвращает различные коды выхода:
- `0` - Успех
- `1` - Общая ошибка
- `V8UNPACK_SHOW_USAGE` - Неправильные параметры командной строки

## Разработка

### Структура проекта

```
src/
├── main.cpp              # Главная точка входа приложения
├── V8File.cpp/.h         # Основная обработка файлов
├── APIcfBase.cpp/.h      # Базовые классы API
├── парсеры метаданных/   # Различные парсеры метаданных
├── утилиты/             # Вспомогательные утилиты
└── SystemClasses/        # Кроссплатформенные утилиты
```

### Внесение вклада

- Форкните репозиторий
- Создайте ветку для новой функциональности
- Реализуйте изменения с комплексным тестированием
- Обновите документацию
- Отправьте pull request

## Лицензия

Этот проект лицензирован под Mozilla Public License v.2.0.

## Авторы

- Оригинальный проект: Денис Демидов (disa_da2@mail.ru)
- Форк и сопровождение: dmpas (sergey.batanov@dmpas.ru)
- Контрибьюторы: fishca, pumbaEO и другие

## История версий

### Версия 3.0
- Оптимизированная сборка контейнера с динамической записью в файл
- Улучшения использования памяти для больших конфигураций
- Расширенные возможности парсинга метаданных

### Версия 2.0
- Предыдущая версия со сборкой контейнера в памяти

## Устранение неполадок

### Распространенные проблемы

**Ошибки памяти при упаковке:**
- Используйте меньшие размеры пакетов для больших конфигураций
- Рассмотрите использование `-nopack` для промежуточных сборок

**Неверный формат файла:**
- Убедитесь, что исходные файлы имеют корректный формат 1C v8
- Проверьте повреждение файлов

**Ошибки доступа:**
- Запускайте с соответствующими правами файловой системы
- Используйте абсолютные пути для сетевых расположений

### Получение помощи

- GitHub Issues: Сообщайте об ошибках и запрашивайте новые возможности
- Документация: Проверяйте специализированные файлы документации
- Сообщество: Проверяйте форумы оригинального проекта и обсуждения
